import type { RecognitionConfig, CropRegion } from "@/types/ml";
import { captureFrame } from "./capture";

const FPS_WINDOW_SIZE = 10;

export interface RecognitionLoopCallbacks {
  onFrame: (imageData: ImageData) => void;
  onFpsUpdate: (fps: number) => void;
}

export interface RecognitionLoop {
  start(
    video: HTMLVideoElement,
    config: RecognitionConfig,
    callbacks: RecognitionLoopCallbacks,
    crop?: CropRegion
  ): void;
  stop(): void;
  isRunning(): boolean;
  getFps(): number;
}

export function computeFpsFromTimestamps(timestamps: number[]): number {
  if (timestamps.length < 2) return 0;
  const first = timestamps[0];
  const last = timestamps[timestamps.length - 1];
  const elapsed = last - first;
  if (elapsed <= 0) return 0;
  return ((timestamps.length - 1) / elapsed) * 1000;
}

export function createRecognitionLoop(): RecognitionLoop {
  let rafId: number | null = null;
  let running = false;
  let frameCount = 0;
  const completionTimestamps: number[] = [];

  function getFps(): number {
    return computeFpsFromTimestamps(completionTimestamps);
  }

  function recordCompletion(callbacks: RecognitionLoopCallbacks): void {
    const now = Date.now();
    completionTimestamps.push(now);
    if (completionTimestamps.length > FPS_WINDOW_SIZE) {
      completionTimestamps.shift();
    }
    callbacks.onFpsUpdate(computeFpsFromTimestamps(completionTimestamps));
  }

  function start(
    video: HTMLVideoElement,
    config: RecognitionConfig,
    callbacks: RecognitionLoopCallbacks,
    crop?: CropRegion
  ): void {
    if (running) return;

    running = true;
    frameCount = 0;
    completionTimestamps.length = 0;

    const reusableCanvas = document.createElement("canvas");

    const loop = (): void => {
      if (!running) return;

      frameCount++;

      if (frameCount % config.frameSkip === 0) {
        const capture = captureFrame(video, crop, reusableCanvas);
        if (capture) {
          callbacks.onFrame(capture.imageData);
          recordCompletion(callbacks);
        }
      }

      if (running) {
        rafId = requestAnimationFrame(loop);
      }
    };

    rafId = requestAnimationFrame(loop);
  }

  function stop(): void {
    running = false;
    if (rafId !== null) {
      cancelAnimationFrame(rafId);
      rafId = null;
    }
  }

  function isRunning(): boolean {
    return running;
  }

  return { start, stop, isRunning, getFps };
}
